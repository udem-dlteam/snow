# Makefile for Scheme Now! framework.

#==============================================================================

# File: "makefile", Time-stamp: <2007-04-04 17:34:42 feeley>

# Copyright (c) 2006-2007 by Marc Feeley, All Rights Reserved.

#==============================================================================

herefromroot = .
rootfromhere = .

snow_version = @SNOW_VERSION@
snow_site_root = @SNOW_SITE_ROOT@
snow_site_dir = $(snow_site_root)/$(snow_version)
snow_site_current_dir = $(snow_site_root)/current
all_snow_hosts = @ALL_SNOW_HOSTS@

PROGRAM_bigloo = @PROGRAM_bigloo@
PROGRAM_chez = @PROGRAM_chez@
PROGRAM_chicken = @PROGRAM_chicken@
PROGRAM_chicken_comp = @PROGRAM_chicken_comp@
PROGRAM_gambit = @PROGRAM_gambit@
PROGRAM_gambit_comp = @PROGRAM_gambit_comp@
PROGRAM_gauche = @PROGRAM_gauche@
PROGRAM_guile = @PROGRAM_guile@
PROGRAM_kawa = @PROGRAM_kawa@
PROGRAM_larceny = @PROGRAM_larceny@
PROGRAM_mit = @PROGRAM_mit@
PROGRAM_mzscheme = @PROGRAM_mzscheme@
PROGRAM_petite = @PROGRAM_petite@
PROGRAM_rscheme = @PROGRAM_rscheme@
PROGRAM_scheme48 = @PROGRAM_scheme48@
PROGRAM_scm = @PROGRAM_scm@
PROGRAM_scsh = @PROGRAM_scsh@
PROGRAM_sisc = @PROGRAM_sisc@
PROGRAM_stalin = @PROGRAM_stalin@
PROGRAM_stklos = @PROGRAM_stklos@

bin_dir = $(snow_site_dir)/bin
base_dir = $(snow_site_dir)/base
pack_dir = $(snow_site_dir)/pack

MKIDIRS = $(rootfromhere)/mkidirs
INSTALL = $(rootfromhere)/install-sh -c
INSTALL_DATA = $(rootfromhere)/install-sh -c -m 644
INSTALL_SOURCE = $(rootfromhere)/install-sh -c -m 644
INSTALL_PROGRAM = $(rootfromhere)/install-sh -c -m 755

BASE_FILES = snow.scm compat-chez.scm compat-chicken.scm compat-kawa.scm \
compat-larceny.scm compat-mit.scm compat-mzscheme.scm compat-scheme48.scm \
compat-scm.scm compat-scsh.scm compat-sisc.scm

CORE_PACKAGES = aes base64 bignum binio cert cgi cryptio \
digest extio filesys fixnum genport \
homovector hostos http list mime random rfc1423 rsa \
snowfort-app snowlib snowman-app sort string \
tar tcpip time ttyui vector zlib

all:
	@echo "To install type: \"make install\""

clean:
	find . -name "*~*" -exec rm "{}" ";"
	find . -name "*.sig" -exec rm "{}" ";"
	rm -f makefile bin/snow bin/snowman bin/snowfort base/snow.scm bin/index.cgi package-list
	rm -rf host*

install:
	$(MKIDIRS) $(bin_dir)
	$(INSTALL_PROGRAM) bin/snow $(bin_dir)/snow
	$(INSTALL_PROGRAM) bin/snowman $(bin_dir)/snowman
	$(INSTALL_PROGRAM) bin/snowfort $(bin_dir)/snowfort
	$(MKIDIRS) $(base_dir)
	@for file in $(BASE_FILES); do \
	  echo $(INSTALL_SOURCE) base/$$file $(base_dir)/$$file; \
	  $(INSTALL_SOURCE) base/$$file $(base_dir)/$$file; \
	done
	$(MKIDIRS) $(pack_dir)
	@for pkg in $(CORE_PACKAGES); do \
	  VERSIONS=`ls pack/$$pkg`; \
	  $(MKIDIRS) $(pack_dir)/$$pkg; \
	  for ver in $$VERSIONS; do \
	    SUBDIRS=`ls pack/$$pkg/$$ver`; \
	    $(MKIDIRS) $(pack_dir)/$$pkg/$$ver; \
	    for sub in $$SUBDIRS; do \
	      FILES=`ls pack/$$pkg/$$ver/$$sub`; \
	      $(MKIDIRS) $(pack_dir)/$$pkg/$$ver/$$sub; \
	      for file in $$FILES; do \
	        echo $(INSTALL_SOURCE) pack/$$pkg/$$ver/$$sub/$$file $(pack_dir)/$$pkg/$$ver/$$sub/$$file; \
	        $(INSTALL_SOURCE) pack/$$pkg/$$ver/$$sub/$$file $(pack_dir)/$$pkg/$$ver/$$sub/$$file; \
	      done; \
	    done; \
	  done; \
	done
	@for snow_host in $(all_snow_hosts); do \
	  echo "Setting up for SNOW_HOST=$$snow_host"; \
	  for pkg in $(CORE_PACKAGES); do \
	    VERSIONS=`ls $(pack_dir)/$$pkg`; \
	    for ver in $$VERSIONS; do \
	      echo "  compiling $$pkg/$$ver"; \
	      (cd $(pack_dir)/$$pkg/$$ver/snow && \
	      SNOW_HOST="$$snow_host" "$(bin_dir)/snow" --compile "$$pkg.scm" \
	      ) || exit 1; \
	    done \
	  done \
	done
	rm -f $(snow_site_current_dir)
	ln -s $(snow_site_dir) $(snow_site_current_dir)
	@echo "Don't forget to add $(snow_site_current_dir)/bin to your PATH"

uninstall:
